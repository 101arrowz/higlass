<!DOCTYPE html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>HiGlass</title>
<style type="text/css">
    .canvasjs-chart-credit {
    display:none;

    .wp-caption: {

    };
}
</style>
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="hglib.css">

    <script crossorigin src="react.development.js"></script>
    <script crossorigin src="react-dom.development.js"></script>
    <script src="pixi.min.js"></script>
    <script src="react-bootstrap.min.js"></script>

    <script src="d3.v4.js"></script>


</head>
<body >
  <div style="display: flex">
    <div id="development-demo" style="width: 50%; background-color: lightgreen;"></div>
    <div id="info-panel">
      <span>X position:</span> <input id='x-position' type='text' /><br>
      <span>Y position:</span> <input id='y-position' /><br>
      <textarea id="description" rows="5"></textarea><br>
      <button id="save-button" style="visibility: hidden">Save</button><br>
      <button id="delete-button" style="visibility: hidden">Delete</button><br>

    </div>
</body>
<script src='hglib.js'>
</script>
<script>

 var baseConf =
{
  "trackSourceServers": [
    "http://higlass.io/api/v1"
  ],
  "editable": true,
  "views": [
    {
      "tracks": {
        "center": [],
        "left": [],
        "right": [],
        "top": [
          {
            "type": "top-axis",
            "local": true,
            "orientation": "1d-horizontal",
            "name": "Top Axis",
            "thumbnail": {},
            "defaultOptions": {},
            "server": "",
            "tilesetUid": "MR07RHs9TmSkxJhNyyjqsA",
            "uid": "HeBuceBRQRymQUPMjfqxtg",
            "options": {},
            "width": 368,
            "height": 20,
            "position": "top"
          },
          {
            "type": "combined",
            "uid": "xyxx",
            "height": 80,
            "width": 368,
            "contents": [
              {
                "uid": "selection",
                "type": "selection-track-horizontal",
                "options": {
                  "projectionFillColor": "#777",
                  "projectionStrokeColor": "#F00",
                  "projectionFillOpacity": 0.3,
                  "projectionStrokeOpacity": 0.7,
                  "strokeWidth": 1,
                  "fillColor": "#777",
                  "strokeColor": "#777",
                  "fillOpacity": 0.3,
                  "strokeOpacity": 0.7,
                  "savedRegions": [
                    {
                      "uid": "x1",
                      "annotation_uid": "y1",
                      "prev_uid": "z1",
                      "x_start": 1346033021.5886,
                      "x_end": 1393263522.5946486
                    }
                  ]
                },
                "position": "top",
                "name": "Horizontal selection",
                "width": 368,
                "height": 80
              }
            ],
            "position": "top",
            "options": {}
          }
        ],
        "bottom": [],
        "whole": [],
        "gallery": []
      },
      "uid": "aa",
      "initialXDomain": [
        1221442217.210575,
        1525183197.8184395
      ],
      "initialYDomain": [
        1386291410.843911,
        1376519583.049556
      ],
      "layout": {
        "w": 12,
        "h": 4,
        "x": 0,
        "y": 0,
        "i": "EhlO1fwhSuyCliHSEzygnA",
        "moved": false,
        "static": false
      }
    }
  ],
  "zoomLocks": {
    "locksByViewUid": {},
    "locksDict": {}
  },
  "locationLocks": {
    "locksByViewUid": {},
    "locksDict": {}
  },
  "valueScaleLocks": {
    "locksByViewUid": {},
    "locksDict": {}
  },
  "selectionLocks": {
    "locksByViewUid": {},
    "locksDict": {}
  }
}

    let hgv = hglib.viewer(
        document.getElementById('development-demo'),
        baseConf,
        {
          bounded: false,
          rangeSelectionOnAlt: true,
        }
    );

let currentRange = null;

const rangeListenerId = hgv.on(
  'rangeSelection',
  range => {
    currentRange = range.dataRange;

    const minValue = Math.min(
      range.dataRange[0] && +range.dataRange[0][0],
      range.dataRange[0] && +range.dataRange[0][1]
    )
    const maxValue = Math.max(
      range.dataRange[0] && +range.dataRange[0][0],
      range.dataRange[0] && +range.dataRange[0][1]
    )

    // if (!range.dataRange[0]) {
    //   d3.select('#save-button')
    //   .style('visibility', 'hidden');
    // } else {
    //   d3.select('#save-button')
    //   .style('visibility', 'visible');
    // }
    d3.select('#x-position')
    .property('value', minValue);
    d3.select('#y-position')
    .property('value', maxValue);
  }
);

let selectedRegion = null;

function updateRegion(prevRegion) {
  let newRegion = prevRegion;

  if (prevRegion.uid) {
    // we're updating an annotation so add it to the chain
    // by setting prev_uid to uid and deleting uid so that
    // it can be reassigned by the server
    newRegion.prev_uid = prevRegion.uid;
    delete newRegion.uid;
  }

  return newRegion;
}

function saveRegion(savedRegion) {
  fetch('//localhost:8000/api/v0/annos-1d/', {
    method: 'POST',
    body: JSON.stringify(savedRegion),
    headers: new Headers({
      'Content-Type': 'application/json'
    })
  }).then((response) => {
    console.log('response', response);
    return response.json();
  }).then((jsonResponse) => {
    console.log('jsonResponse:', jsonResponse);
  });
}

d3.select('#save-button')
.on('click', () => {
  // const viewconf = hgv.getViewConfig();
  // const track = viewconf.views[0].tracks.top[2].contents[1];

    // if (!track.options.savedRegions) {
    //   track.options.savedRegions = [currentRange];
    // } else {
    //   track.options.savedRegions += [currentRange];
    // }
    const desc = d3.select('#description');
    console.log('desc.value', desc.node().value);

    const newRegion = updateRegion(selectedRegion);
    newRegion.description = desc.node().value;

    console.log('newRegion:', newRegion);
    saveRegion(newRegion);

  // hgv.setViewConfig(viewconf);
});

d3.select('#delete-button')
.on('click', () => {
  // const viewconf = hgv.getViewConfig();
  // const track = viewconf.views[0].tracks.top[2].contents[1];

    // if (!track.options.savedRegions) {
    //   track.options.savedRegions = [currentRange];
    // } else {
    //   track.options.savedRegions += [currentRange];
    // }
    const desc = d3.select('#description');
    console.log('desc.value', desc.node().value);

    const newRegion = updateRegion(selectedRegion);
    newRegion.latest = false;
    console.log('newRegion:', newRegion);
    saveRegion(newRegion);

  // hgv.setViewConfig(viewconf);
});

setTimeout(() => {
  const trackObj = hgv.getComponent().getTrackObject('aa', 'selection');


  trackObj.localPubSub.subscribe('track.regionSelected', (region) =>{
    selectedRegion = region;

    console.log('selected:', region);

    d3.select('#save-button')
      .style('visibility', 'visible');
    d3.select('#delete-button')
      .style('visibility', 'visible');

    d3.select('#description')
      .property('value', region.description);
  });

  trackObj.localPubSub.subscribe('track.regionUnselected', () => {
    selectedRegion = null;

    console.log('unselecting');
    d3.select('#save-button')
      .style('visibility', 'hidden');
    d3.select('#delete-button')
      .style('visibility', 'hidden');
  });

  trackObj.localPubSub.subscribe('track.brushEnded', (oldRegion) => {
    console.log('oldRegion', oldRegion);
    const savedRegion = updateRegion(oldRegion);

    savedRegion.x_start = Math.floor(savedRegion.x_start);
    savedRegion.x_end = Math.floor(savedRegion.x_end);

    console.log (JSON.stringify(savedRegion));
    saveRegion(savedRegion);
    
    // check if this object exists
  });

  console.log('trackObj:', trackObj);
});
   // window.hgApi.getComponent().tiledPlots.aa.handleAddTrack('top');

 // window.hgApi.activateTool('select-limited');

</script>
</html>
