<!DOCTYPE html>
<html lang="">
<head>
<meta charset="utf-8">
<title>Goomba</title>
</head>
<body>

<!-- build:js scripts/goomba.js -->
<script src='scripts/goomba.js'></script>
<!-- endbuild -->

<div class="ui-widget" id='position-search-div'>
    <input type="text"  id="position-search-text" placeholder="chr1:100000 to chr1:200000" onkeypress="keyPressed(event)" style="left:30px">
    <span class="input-group-btn">
        <button class="btn btn-default" type="button" id='position-search-button' onclick="searchPosition()">Go!</button>
    </span>
</div>

<div id="circle"></div>

<script type='text/javascript'>

let width = 600;
let height = 140;

let trackHeight = 30;
let margin = {'left': 30, 'top': 10, 'right': 30, 'bottom': 10};
let tileDirectory = 'http://pkerp.s3-website-us-east-1.amazonaws.com/data/hg19/refgene-tiles-plus'
let tileDirectories = ['http://pkerp.s3-website-us-east-1.amazonaws.com/data/hg19/refgene-tiles-plus']
                       //'http://pkerp.s3-website-us-east-1.amazonaws.com/data/hg19/refgene-tiles-minus']

var chromInfoFilename = 'http://pkerp.s3-website-us-east-1.amazonaws.com/data/hg19/chromInfo.txt';
var svg = d3.select('#circle').append('svg')
.attr('width', width)
.attr('height', height)

let searchField = null;

goomba.ChromosomeInfo(chromInfoFilename, (chromInfo) => {
    let xScale = d3.scale.linear().domain([0, chromInfo.totalLength])
        .range([0, width - margin.left - margin.right]);


    //let xScale = d3.scale.linear().domain([0, 200000000])

    console.log('chromInfo:', chromInfo);
    let zoomDispatch = d3.dispatch('zoom');
    searchField = new goomba.SearchField(chromInfo, xScale.copy(), zoomDispatch);

    var chromInfoPlot = goomba.ChromosomeAxis()
    .width(width - margin.left - margin.right)
    .domain(xScale.domain())
    .zoomDispatch(zoomDispatch);

    svg.append('g')
    .attr('transform', 'translate(' + margin.left + ',0)')
    .datum(chromInfo)
    .call(chromInfoPlot);

    let tileLayout = goomba.GeneTileLayout();

    let gMain = svg.append('g')
    .classed('g-main', true);

    /////////////////////////////
    let tiledArea = goomba.TiledArea().width(width)
    .height(height)
    .dataPointLayout(goomba.GenePlot)
    .tileLayout(tileLayout)
    .domain(xScale.domain())
    .margin({'left': 30, 'top': 50, 'right': 30, 'bottom': 10})
    .zoomDispatch(zoomDispatch);

    let gGeneTracks = gMain
        .append('g')
    .selectAll('g')
    .data(tileDirectories)
    .enter()
    .append('g')
    .attr('transform', (d,i) => { return 'translate(0,' + i * trackHeight + ')'; })
    .classed('track-g', true)
    .call(tiledArea)

    let zoomableLabels = goomba.ZoomableLabels()
    .markerClass('.gene-marker')
    .labelClass('.gene-label')
    .labelParent(gMain)
    .labelMarkerId((d) => { return `n-${d.refseqid}`})
    .uidString('refseqid')

    tiledArea.on('draw', () => {
        gGeneTracks.call(zoomableLabels);
    });


    ////////////////////////

    /*
    let wiggleTileArea = goomba.TiledArea().width(width)
    .height(height)
    .dataPointLayout(goomba.GenePlot)
    .tileLayout(goomba.WiggleTileLayout())
    .domain(xScale.domain())
    .margin({'left': 30, 'top': 30, 'right': 30, 'bottom': 10})
    .zoomDispatch(zoomDispatch);

    let gWiggleTracks = gMain
    .append('g')
    .attr('transform', 'translate(0,' + (tileDirectories.length * trackHeight) + ')')
    .selectAll('g')
    .data(['https://s3.amazonaws.com/pkerp/data/ENCODE/2016-05-16-GM12878-RNASeq/tiles'])
    .enter()
    .append('g')
    .attr('transform', (d,i) => { return 'translate(0,' + i * trackHeight + ')'; })
    .classed('track-g', true)
    .call(wiggleTileArea)
    */

    
    //let gWiggleTracks = gMain.
});

function searchPosition() {
    var text = d3.select('#position-search-text').property('value');

    var pos = searchField.searchPosition(text);
    
    console.log('text:', text, 'pos:', pos);
}

function keyPressed(e) {
    if(e.keyCode === 13){
        console.log('enter pressed');
        searchPosition();
    }
}

</script>
</body>
</html>
